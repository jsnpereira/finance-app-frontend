version: "3.8"

services:
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Interface Web

  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak-prod
    env_file:
      - .env
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: mysql
      KC_DB_URL: ${KC_DB_URL:-jdbc:mysql://seu-banco-aws.rds.amazonaws.com:3306/keycloak?useSSL=true&serverTimezone=UTC}
      KC_DB_USERNAME: ${KC_DB_USERNAME:-keycloak}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-senha_segura}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME: ${KC_HOSTNAME:-localhost}
      KC_TRANSACTION_XA_ENABLED: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
    command: ["start", "--import-realm"]
    depends_on:
      - mailhog
    ports:
      - "8080:8080"
    volumes:
      - ./finance-realm-config:/opt/keycloak/data/import
    restart: unless-stopped

  finance-app-frontend:
    build: .
    container_name: finance-app-frontend
    ports:
      - "3000:80"
    env_file:
      - .env.prod
    depends_on:
      - keycloak
    restart: unless-stopped
